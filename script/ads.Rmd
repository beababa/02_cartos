---
title: "Recup fichier ads"
author: "B. Maranget"
date: "20/10/2021"
output: 
  html_document: 
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
# Passer la valeur suivante à TRUE pour reproduire les extractions.
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```


# Objet

reprise de données ADS pour Operis - Oxalis


# Conversion XLS CSV

A ne faire qu'une fois pour pouvoir travailler sur le linux

```{r}
library(xlsx)
library(readxl)
ADSOp <- read.xlsx("../data/Format_ADS2007.xls", startRow= 1, header = TRUE,sheetIndex = 1, encoding = "UTF-8")
write.csv(ADSOp, "../data/adsOp.csv", fileEncoding = "UTF-8")
i <- 1
for (i in 1:10) {
  data <- read_excel("../data/REGISTRE ADS.xls", sheet = i)
  write.csv(data, paste0("../data/ads", i, ".csv"), na ="", fileEncoding = "UTF-8")
}
```

Nettoyage du fichier 

Pb d'encodage sur lg de titre, on ouvre avec libre office
TODO retester avec un enregistrement en UTF-8

```{r}
registre <- read.csv("../data/ads1b.csv")
# 26 colonnes uniquement et 5358 dossiers
noms <- names(registre)[1:26]
registre <- registre [c(1:5358), noms]
```

Etablissement de la table d'équivalence

```{r}
modele <-  read.csv("../data/adsOp1.csv")
equiv <- modele [,c("COLONNES", "MAIRIE", "MAIRIE.2")]
```

Construction du df d'arrivée

58 colonnes

création d'une matrice convertie ensuite en df

```{r}
nomsModele <- modele$COLONNES
nbData <- length(nomsModele)*length(registre$X)
df <-  NA
df <- matrix(data = 0,nrow = 5358, ncol = 58)
df <- data.frame(df)
names(df) <- nomsModele
```



Equivalence simple

On prend la table des équivalences, certaines colonnes ne fonctionneront pas mais
le try permettra de gérer l'erreur
Pour les noms de colonnes avec des "'" et des " ", on remplace par des points

```{r}
equiv$MAIRIE3 <- gsub(" |'", ".",equiv$MAIRIE)
for (i in 1:58) {
  print(i)
  try(df [ , equiv$COLONNES [i]] <- registre [,equiv$MAIRIE3[i]])
}
write.csv(df, "../data/premierJet.csv", fileEncoding = "UTF-8")
```


Les parcelles : section et numéro

Le problème

Il y a deux colonnes qu'il faut concaténer mais pl sections et pl numéros

```{r}
registre [, c("section.cadastrale","n..parcelle")]
```






