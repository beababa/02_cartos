---
title: "Lidar"
author: "B. Maranget"
date: "11/09/2024"
output: 
  html_document: 
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
# Passer la valeur suivante à TRUE pour reproduire les extractions.
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```


# Objet

explorer Lidar et R

https://r-lidar.github.io/lidRbook/io.html



# Environnement


## Librairies


```{r , eval=TRUE}
library(sf)
library(lidR)
library(rgl)# pour visu 3d
library(mapsf)
library(leaflet)
library(mapview)
```



## Chemins

Les fichiers de téléchargement sont lourds. donc restent dans téléchargements.

```{r}
chemin1 <- "C:/Users/tachasa/Downloads/"
chemin2 <- "D:/03_SIG/03_03_Data/03_SOCLE/"
zone <- paste0(chemin2, "zones.gpkg")
zone <- st_read(zone, "zonesNouvellesRue")
zone <- st_read(zone, "zones")
ind <- 4
zac <- st_transform(zone [ind,],2154)
mapview(zac)
c <- st_coordinates(zone [4,])
summary(c [,1])
summary(c [,2])
b <- st_bbox(zone [ind,])
e <- st_convex_hull(zone [ind,])
p <- (st_cast(e, "POINT"))
mapview(p)
test <- st_centroid(p [2,], p [5,])
mapview(test)
las_tr <- clip_transect(las, p [1,], p[2,], width = 50, xz = TRUE)
locator()
las_tr <- clip_transect(las, p1, p2, width = 50, xz = TRUE)

```




```{r}
# pour la ZAC
LASfile <- "C:/Users/bmaranget/Downloads/LHD_FXX_0661_6868_PTS_O_LAMB93_IGN69.copc.laz"
# pour le cimetière
LASfile <- "C:/Users/tachasa/Downloads/LHD_FXX_0662_6867_PTS_O_LAMB93_IGN69.copc.laz"
las <- readLAS(LASfile, select = "xyz")
print (las)
las_check(las)
sep <-  readLAS(sel, filter = "-keep_first -drop_z_below 50 -drop_z_above 53")
las <-  readLAS(LASfile, filter = "-keep_first")
```


```{r}
ground <- filter_poi(las, "Classification" == 2L, "ReturnNumber"== 1L)
ground <- filter_poi(sel, Z>52, Z<54)
plot(ground)
ground_sf <- st_as_sf(ground)
selC <- classify_ground(sel, algorithm = pmf(ws = 5, th = 3))
selC <- classify_ground(sel, algorithm = csf())
plot(selC)
hist(selC$Z)
plot(selC, color = "Classification", size = 3, bg = "white") 
```




```{r}
plot(las)
plot(sel)
plot(ground)
plot(ground, color = "Classification", bg = "white", axis = TRUE, legend = TRUE)

```

couper le las

définir 2 pt

```{r}
p1 <- st_point(c(2.47542315, 48.9073))
p2 <- st_point(c(2.4782, 48.9074))
sfc <- st_sfc(p1,p2, crs = 4326)
st_transform(sfc, crs =2154)
p1 <- c(661560.1  ,6867634 )
p2 <- c(662054.2, 6867694 )
las_tr <- clip_transect(las, p1, p2, width = 100, xz = TRUE)
df <- payload(las_tr)
class(df)
sfc <- st_sfc(st_point(c(df$X, df$Y)))
st_as_sf(df, coords = c("X", "Y", "Z"), epsg = 2154)
```



```{r}
sel <- clip_roi(las, zac)
```


vue 2d

```{r}
library(ggplot2)

ggplot(payload(las_tr), aes(X,Z, color = Z)) + 
  geom_point(size = 0.5) + 
  coord_equal() + 
  theme_minimal() +
  scale_color_gradientn(colours = height.colors(50))
```


Sans l'option, 1 G°, avec l'option, 400 M° voire 49,5 M°



traduction rapide du manuel lidR

https://r-lidar.github.io/lidRbook/io.html

donnée position x y z intensité rang angle d'incidence

laz format compressé de las

l'objet est constitué de l'en tête et du nuage de point




# rgl



# couper



# enregistrer

```{r}
writeLAS(sel, "../data/cimetiereLidar.las")
sel <- readLAS("../data/cimetiereLidar.las")
plot(sel)
```



# présenter


```{r}
las <- readLAS("../data/zacLidar.las")
plot (las)
las
plot(sel, color = "Classification", bg = "white", axis = TRUE, legend = TRUE)
df <- payload(las)
df
```





# batiment

tester l'orga planaire des points

```{r}

```

