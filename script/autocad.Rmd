---
title: "Autocad"
author: "B. Maranget"
date: "26/07/2023"
output: 
  html_document: 
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
# Passer la valeur suivante à TRUE pour reproduire les extractions.
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```


# Objet

Récupérer les données autocad et la donnée liée à la fibre.
à savoir :
- 

les projections sont lambert II

mais également traiter des geosjon avec les pb de "consistent type"


# Librairies, chemins, données

```{r}
library(sf)
library(mapsf)
library(units)
```



```{r}
cheminCAD <-  paste0( "D://03_SIG/03_01_Archive/02_AUTOCAD/")
chemin <- c("C:/Users/tachasa/02_carto/script")
chemin <- c("C:/Users/tachasa/02_cartos/script/")
getwd()
bondy <- st_read("../data/limitesSocle.gpkg", "bondy")
rue <- st_read("../data/rueOSM.geojson", query = "SELECT name FROM rueOSM")
```

```{r}
getwd()
setwd(chemin)
#rmq le geojson rue OSM ne comprend que les rues MLK-blanqui
rue <- st_read("../data/rue2023.geojson", query = "SELECT name FROM rue2023")
# le query permet de sélectionner uniquement la colonne name
```


```{r}
setwd(cheminCAD)
chemin <- c("C:/users/tachasa/02_carto/script/")
```



# Exploration différents formats




## DXF

quand la conversion est impossible dans R
ogr2ogr -dim XYZM -progress --config OGR_GEOMETRY_ACCEPT_UNCLOSED_RING NO test.gpkg _CF-Verdun.dxf


```{r}
fic <-list.files(".", pattern = ".dxf")
fic <- fic[c(4,5,8,15,16)]
fic
ficDest <- c("elie", "verdun", "benhamou", "lebas", "gare")
fin <- NULL
ficFin <- NULL
i <- 1
for (i in 1:5){
#gdal_utils(util = "vectortranslate",
 #          source = fic [i],
  #         destination = paste0(i,".dxf"),
   #        options = c("-dim", "XY", "-skipfailures"))
  tmp <-st_read(paste0(i, ".dxf"))
  table(tmp$Layer)
  tmp <- tmp [tmp$Layer %in% sel$fin,1]
  tmpCouche <- tmp [,1, drop = T]
  ficFin <- rbind(tmp, ficFin)
  fin <- c(tmpCouche, fin)
  assign(ficDest [i], tmp)
}

st_bbox(elie)
st_bbox(verdun)
st_bbox(benhamou)
st_bbox(lebas)
st_bbox(gare)
st_bbox(ficFin)
bondy27561 <-st_transform(bondy, 3947)
st_crs(benhamou) <- 2154 
benhamou2154 <- st_transform(benhamou, 2154)
mf_map(bondy)
mf_map(ficFin)
mf_map(benhamou, add = T)

st_bbox(bondy)
st_bbox(bondy27561)
st_bbox(rue)
tab <- table(fin)
setwd("C:/Users/tachasa/02_cartos/")
getwd()
write.csv(tab,"data/couchesCAD.csv", fileEncoding = "UTF-8")
# on rajoute une colonne sel
couchesCAD <- read.csv("data/couchesCAD.csv")
str(couchesCAD)
sel <- couchesCAD [couchesCAD$Sel == "O",]
# sel représente toutes les couches intéressantes

st_layers(fic)
fic <- st_zm(fic)
st_zm(fic)
st_crs(fic) <- 27561
fic <- st_transform (fic, 2154)
```

extraction des données fibre uniquement

```{r}
fic <- fic [fic$Layer %in% c("CF-TOPO-TELECOM", "OBJET_TELECOM"),]
mf_map(fic)
```


## geoJSON

A l'étape carto, un msg d'erreur renvoie "consistent type".
cela signifie que la geometry collection de geosjon pose pb.
une solution consiste à isoler les points puisqu'ils ne peuvent pas être castés en lg (étape obligatoire pour avoir une géométrie affichable)

```{r}
rue <- ficFin
mf_map(rue)
table(st_geometry_type(rue$geometry))
rueLG <- rue [st_geometry_type (rue$geometry) != "POINT",]
rueLG <- st_cast(rueLG, "LINESTRING")
table(st_geometry_type(rueLG))
rueLG <- st_transform(rueLG, 2154)
mf_map(rueLG)
setwd(chemin)
st_write (rueLG, "../data/bbox.gpkg", "test", delete_layer = T)

```

### Carto


```{r}
mf_init(fic)
mf_map(bondy, col = "wheat", add = T)
mf_map(rueLG, add = T)
mf_label(rueLG, var = "name", halo = T, overlap = F)
mf_map(fic, add = T)


fic
bondy
```


# Bbox

On met les bbox semblables dans le même fichier

```{r}
res <-(st_union(st_as_sfc(gare), st_as_sfc(verdun) ))
mf_map(res)

table(sapply(res, length))
st_crs(gare)
st_crs(benhamou)
st_crs(verdun)
st_bbox_by_feature = function(x) {
  x = st_geometry(x)
  f <- function(y) st_as_sfc(st_bbox(y))
  do.call("c", lapply(x, f))
}
mf_map(st_union(st_as_sfc(benhamou)))
mf_map(benhamou)
```


```{r}
