---
title: "rue base référentiel"
author: "B. Maranget"
date: "6/02/2023"
output: 
  html_document: 
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
# Passer la valeur suivante à TRUE pour reproduire les extractions.
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```


# Objet

Fichier rue, constitution grille et liste des rues dans graticules

Egalement liste des rues dans delib

## Librairies


```{r}
library(sf)
library(mapsf)
library(osmdata)
library(tidyverse)
```


chemins

```{r}
chemin <-  paste0(Sys.getenv('HOME'), "/03_SIG/03_03_Data/")
```


données

```{r}
st_layers(paste0(chemin, "03_SOCLE/rue.gpkg"))
rue <- st_read(paste0(chemin,"03_SOCLE/rue.gpkg"), "rue2023c")
str(rue)
# maj longueur
rue$Longueur <- round(st_length(rue$geom),0)
sum(rue$Longueur)

# verif doublon
tab <- table(rue$NOM_1_G)
tab [tab >1]
# remplacementNONNumero
num <- as.character(seq(1,17))
rue$NOM_1_G [rue$NOM_1_G %in% num] <- rue$NOMnumero [rue$NOM_1_G %in% num]
rue[!is.na(rue$NOMnumero),]
# extraction type rue
explode <- strsplit(rue$NOM_1_G, " ")
rue$NATURE <- sapply(explode, "[",1)
table(rue$NATURE)
agg <- aggregate(rue$Longueur, by = list(rue$NATURE), sum )
agg
```


# Liste


```{r}
liste <- rue [, c("NOM_1_G", "IMPORTANCE", "Longueur", "NATURE"), drop = T]
write.csv(liste [order (liste$"NOM_1_G" ),], "../data/listeRues.csv", fileEncoding = "UTF-8")
```


# Zonage batiments et parcelle


On discrétise à l'identique batiment (osm) et (parcelles p morales)

en fait, on sélectionne bat et parcelle par rapport au point

```{r}
building <- location %>%
   add_osm_feature(key = "building") %>%
   osmdata_sf()
```


```{r}
str(building$osm_polygons)
inter <- st_intersection( building$osm_polygons [, c("name", "osm_id")], poi)
# l'intersection renvoie un point et non pas un polygone dont je n'arrive pas à me débarasser...
noms <- names (inter)
inter <- st_drop_geometry(inter)
class(inter)
jointure <- merge (inter, building$osm_polygons [, "osm_id"] , by = "osm_id")
jointure <- st_as_sf(jointure)
st_write(jointure, "../data/poi.gpkg", "building", delete_layer = T)
class(jointure)
```


```{r}
st_layers("../data/cadastre.gpkg")
cadastre <- st_read("../data/cadastre.gpkg", "parcelleAdresse")
cadastre <- st_transform(cadastre, 4326)
inter <- st_intersection(cadastre, poi)
inter <- st_drop_geometry(inter)
str(inter)
inter$geo_parcelle
str(cadastre)
cadastre$geo_parcelle
jointure <- merge(cadastre [, c("adresse", "geo_parcelle")], inter, by = "geo_parcelle")
st_write(jointure, "../data/poi.gpkg", "parcelle")
```

