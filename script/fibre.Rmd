---
title: "fibre"
author: "B. Maranget"
date: "02/05/2023"
output: 
  html_document: 
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
# Passer la valeur suivante à TRUE pour reproduire les extractions.
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```


# Objet

exploitation du fichier opendata mv_immeubles_2022_03_09.csv, point immeuble fibre

récupération dans C:\Users\bmaranget\Documents\01_ARCHIVE\fibre\Fibre Bondy DSI des kmz
(Bondy V5.kmz)


```{r}
library(sf)
library(mapsf)
library(rgdal)
```


# Chemin data


```{r, eval = T}
# on reprend variable HOME en fonction PC
rep <- Sys.getenv("HOME")
fic <- paste0(rep,"/01_ARCHIVE/02_fibre/01_DSI/01_plans/testV5.kmz")
st_read(fic)

ogrListLayers(fic)
data <- readOGR(chemin, "Filaire")

```


# Download .shp data
u_shp <- "http://coagisweb.cabq.gov/datadownload/biketrails.zip"
download.file(u_shp, "biketrails.zip")
unzip("biketrails.zip")
u_kmz <- "http://coagisweb.cabq.gov/datadownload/BikePaths.kmz"
download.file(u_kmz, "BikePaths.kmz")

# Read file formats
biketrails_shp <- st_read("biketrails.shp")
if(Sys.info()[1] == "Linux") # may not work if not Linux
  biketrails_kmz <- st_read("BikePaths.kmz")
u_kml = "http://www.northeastraces.com/oxonraces.com/nearme/safe/6.kml"
download.file(u_kml, "bikeraces.kml")
bikraces <- st_read("bikeraces.kml")



# Chargement des fichiers

ajout 12/7
Comme le kmz est illisible, on ouvre la v4 sous qgis et on enregistre pt lg poly
dans des .gpkg
on cherche surtout les chambres / armoires (points)


```{r}
chemin <- paste0(rep, "/03_SIG/03_03_Data/22_VIDEOSURVEILLANCE/")
fic <- paste0(chemin,"point.gpkg")
couches <- st_layers(paste0(chemin,"point.gpkg"))
# boucle d'ouverture
concatenerCouches <- function (fic){
  couches <- st_layers(fic)
  fin <- length(couches$name)
tmp <- NULL
data <- NULL
for (i in 1:fin){
  tmp <- st_read(fic, couches$name [i])
  tmp <- st_transform(tmp,  4326)
  tmp$description <- couches$name [i]
  data <- rbind(data, tmp)
} 
return(data)
}
fic <- paste0(chemin,"ligne.gpkg")
lg <- concatenerCouches(fic)
mf_map(lg)



st_write(data,"../data/fo.gpkg", "point")
st_write(lg,"../data/fo.gpkg", "lg")
```


vérif
pas de doublons
géométrie valide

```{r}
table(duplicated(data$geom))
anyDuplicated(data$geom)
```

```{r}
st_length(lg$geom)
lg$longueur <- st_length(lg$geom)
library(units)
lg$longueur <- drop_units(lg$longueur)
ind <- which(lg$longueur == 0)
lg <-  lg [-ind,]
mf_map(lg)
```






