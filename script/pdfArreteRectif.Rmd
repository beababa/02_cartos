---
title: "OCR arrêté"
author: "B. Maranget"
date: "20/07/2021"
output: 
  html_document: 
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
# Passer la valeur suivante à TRUE pour reproduire les extractions.
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```


# Objet

Ouverture fichier pdf arrêté lecture numéro d'arrêté


# Import

```{r}
library(pdftools)
library(tidyverse)
library(tesseract)
library(magick)
library(tictoc)
```
Ne pas jouer

```{r, eval = FALSE}
path <- dir (path = "C:/ARRETES/MODIF/", pattern = "*.pdf", full.names = TRUE)
for (i in 1:length(path)){
  pngfile <- pdftools::pdf_convert(path[i], dpi = 100)
}
```


```{r, eval = FALSE}
# attention répertoire
path <- dir (pattern = "*Arretes",full.names = TRUE)
images <- map(path, magick::image_read)
tic()
text_list <- map(images, ocr)
toc()
stext <- str_split(text_list, "\n")
stext
```


```{r}
# 232 textes 2 exemples
images[91]
(extr <- stext [[91]])
# fonctions pour chercher chaine
chercherType <- function (chaine) {
  lg_type <- grep("A2021",chaine, ignore.case = TRUE,value = FALSE)
}
vLoc <- c("rue","allée","villa","chemin","avenue","place","voies","Esplanade")
chercherLoc <- function (chaine) {
  lg_loc <- grep("rue|allée|villa|chemin|avenue|place|voies|Esplanade",chaine, ignore.case = TRUE,value = FALSE)
}
premiereOccurence <- function(liste) {
  vecteur <-  NULL
  i <- 1
  for (i in 1:length(liste)) {
    tmp <- liste [[i]][1]
    vecteur <- c(vecteur, tmp)
  }
  return(vecteur)
}
liste <- lapply(stext, chercherType)
liste
# plusieurs occurences car réf VU
lgType <- premiereOccurence(liste)
# filtrage uniquement sur les vrais arrêtés
ok <- which(!is.na(lgType))
stextSel <- stext [c(ok)]
# 194 vrais arrêtés
# test pour vérifier
liste <- lapply(stextSel, chercherType)
liste
lgType <- premiereOccurence(liste)
length(which(is.na(lgType)))==0
# pas de NA dans la liste des arrêtes
# on cherche les adresses
liste <- lapply(stextSel, chercherLoc)
liste
lgLoc <- premiereOccurence(liste)
pb <- which(is.na(lgLoc))
# pb empty c'est pas de pb
stextSel[c(pb)]
loc <- NULL
i <- 1
for (i in 1:length(stextSel)){
  tmp <- stextSel [[i]][lgLoc[i]]
  loc <- c(loc, tmp)
}
head(loc)
# sauvegarde du résulat
write.csv2(loc, "lieux.csv")
grep("Villa", loc [1], value = TRUE)

locgeo <- geocode(loc, limit = 1, key = "place")

m <- gregexpr("(?i)(?m)(?<=un\\b)(.+)(?=terre\\b)", x, perl=T)
res <- regmatches(x, m)
res <- unlist(res)
res <- gsub("(^ +| +$)", "", res)

res
[1] "mot banni de notre"                            "tremblement de"                               
[3] "mot engendre un mot, une étincelle embrase la"
cat(paste("Ligne", 1:length(res), res, collapse="\n")
    
    
vloc

```

