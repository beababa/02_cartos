---
title: "Projet photo points chaud stationnement"
author: "B. Maranget"
date: "5/07/2024"
output: 
  html_document: 
    number_sections: yes
    toc: yes
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = TRUE)
# Passer la valeur suivante à TRUE pour reproduire les extractions.
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```


# Objet

Récupération photo, retailler, créer la clé, spatialiser et projeter leaflet.

egalement utilisé pour photo pmr / place livraison (campagne juin-juillet 2024)

# Environnement


## Librairies


```{r , eval=TRUE}
library(dplyr)
library(leaflet)
library(leafpop)
library(sf)
library(mapsf)
library(exiftoolr) # metadonnées photo
library(magick)
library(filesstrings)
```


## Chemins


```{r}
Sys.getenv("HOME")
cheminPhoto <- paste0(Sys.getenv("HOME"),"/03_SIG/03_03_Data/05_PHOTOS/stationnement/")
cheminPhoto <- "S:/VOIRIE PHOTO STATIONNEMENT/"
cheminPhoto
```



# Données


## photos


```{r}
photo <- list.files(path.expand(cheminPhoto), pattern = "*.JPG|.jpg")
photo
```




## Récup métadonnées photo

```{r}
lireMeta <- function(fic){
  exif_read(path.expand(paste0(cheminPhoto,  fic)))
} 
meta <- lireMeta(photo)
```

tri éventuel sur la date et déplacement


```{r}
str(meta$FileModifyDate)
meta$jour <- substring(meta$FileModifyDate,1,10)
table(meta$jour)
file.move(meta$SourceFile [meta$jour == "2024:07:08"], paste0(cheminPhoto,"/traités") )
```



## Réduction taille photo


Les photos sont dans ../img et on archive les photos dans traités

```{r}
i <- 1
for (i in  c(1:length(meta$FileModifyDate))){
  nom <- meta$FileName [i]
  img <- image_read(meta$SourceFile [i], density = NULL, depth = NULL, strip = FALSE)
  img2 <- image_scale(img, geometry = "400")
  image_write(img2, path = paste0("../img/", nom), format = NULL, quality = NULL,
              depth = NULL, density = NULL, comment = NULL, flatten = FALSE)
}
# archivage photos originales
file.move(meta$SourceFile, paste0(cheminPhoto, "/traités"))
```

# identifiants et paramètres

```{r}
meta$FileName
# on extrait les 3 derniers caractères avant l'extension
nb <- nchar(meta$FileName)
meta$nom <- substr(meta$FileName,nb-6,nb-4)
meta$nomN <- paste0("<b>Num Photo :</b> ",meta$nom, "<br />")
```

```{r, eval=F}
# traitement des NA
meta$photoC <- paste0("../img/", meta$FileName)
metasf$photoC
```


# spatialisation

```{r}
metasf <- st_as_sf(meta, coords = c("GPSLongitude", "GPSLatitude"), crs = 4326)
```

# enregistrement

il faut concaténer avec les données déjà acquises

```{r}
st_write(metasf, "../data/stationnement.gpkg", "genant",append = T )
st_write(metasf, "../data/stationnement1.gpkg", "pmr", delete_layer = T )
```





# Leaflet


## rouverture du fichier



```{r}
metasf <- st_read("../data/stationnement.gpkg", "genant")
```

# vérification doublons

```{r}
metasf <- metasf [!duplicated(metasf)]
```






```{r, eval=TRUE}
m =leaflet() %>%
  addProviderTiles("OpenStreetMap.France") %>%
  addMarkers(data = metasf, group= "metasf", popup = ~nomN, label = metasf$nom) %>%
addPopupImages(image = metasf$photoC, group = "metasf", height = 300, width = 300) 
```

```{r, eval=TRUE}
leaflet() %>%
  addProviderTiles("OpenStreetMap.France") %>%
  addMarkers(data = metasf, group= "metasf", popup = ~nomN, label = metasf$nom) %>%
addPopupImages(image = metasf$photoC, group = "metasf", height = 300, width = 300) 
```



export du leaflet

```{r}
library(mapview)
dateJour <- Sys.Date()
mapshot(m, url =paste0(cheminPhoto,"03_carte/genant_",dateJour,".html"))
mapshot(m, url =paste0("../img/pmr",dateJour,".html"))
```


