---
title: "larves"
output: 
 html_document: 
  number_sections: yes
  toc: yes
editor_options: 
 chunk_output_type: console
#fig_width: 6 
#fig_height: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
# Passer la valeur suivante à TRUE pour reproduire les extractions.
knitr::opts_chunk$set(eval = TRUE)
knitr::opts_chunk$set(warning = FALSE)
#knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```
```{r}
library(sf)
library(cartography)
library(RColorBrewer)
library(mapview)
```

# Objet

Etablir la donnée permettant de cartographier l'évolution du pourcentage d'attaques et
de la population de larves pour la région Champagne Ardenne.

La carto sera faite sous Qgis.

La difficulté est ici que dans les données 2020, les coordonnées sont fournies mais pas 
dans le fichier 2019.

Du coup, on cherche d'abord si il est utile de reprendre les coordonnées. 
En fait, d'une année sur l'autre, les villes ont changé.
Donc, on fait une jointure sur la table IGN des communes.
Mais deux communes sont exclues de cette jointure, on finit par reprendre les coordonnées
uniquement pour ces deux communes.



# Données

## Assemblage des 4 fichiers de données

```{r}
fic <- list.files("../data/", pattern = "01_")
n <- length(fic)
data <- NULL
lat <-  NA
long <-  NA
i <- 1
for (i in 1:n) {
  tmp <-
    read.csv2(paste0("../data/", fic [i]),
              header = FALSE ,
              skip = 1, stringsAsFactors = FALSE)
  # extraction type carte (popLarve ou pctAttaque) et année
  tmp
  nom <- substring(fic [i], 4, 10)
  # rajout colonne lat long sur 2019
  # test sur le nb de colonnes
  if (length (tmp) < 4) {
    tmp <- cbind (tmp, lat, long)
    tmp
    tmp <- tmp [, c( "V1", "V2" ,  "lat", "long", "V3")]
  }
  tmp <- cbind(nom, tmp)
  names(tmp) <-  c("categ","commune", "numINSEE", "lat", "long",  "nb")
  data <- rbind (data, tmp)
}
# fichier communes pour jointure
if (Sys.getenv("PWD") == "/home/tachasa/02_cartos") { chemin <- "../00_DATA/"
} else  {
  chemin <- paste0 (Sys.getenv("OneDrive"),"\\beaCarto\\data sauve\\")
  }
com <- st_read(paste0(chemin, "ign.gpkg"), "commune", quiet = TRUE, stringsAsFactors = FALSE)
```

Eclatement de la colonne commune en an et categorie

```{r}
data$an <- substring(data$categ, 4,7)
data$categ1 <- substring(data$categ,1,3) 
str(data)
write.csv(data, "../data/larves.csv")
```

# Existence de commune sans long lat

On cherche les communes sans long lat.


```{r}
numINSEE <- names(table(data$numINSEE))
# 115 communes différentes sur l'ensemble de la donnée 
numINSEE2020 <- unique(data [data$an == 2020, "numINSEE"])
# 66 communes ont long lat
diff <- setdiff(numINSEE, numINSEE2020)
```

49 communes sans long lat, cela justifie une jointure via code INSEE. On abandonne
les long lat données.


# Jointures attributaires


```{r}
com$numINSEE <- as.integer(com$INSEE_COM)
joint  <- merge(com, data, all.y = TRUE, by = "numINSEE")
(pb <- joint [is.na(joint$NOM_COM),])
joint <- joint [!is.na(joint$NOM_COM),]
str(pb)
pb <- pb [pb$lat!="",]
pb <- pb [,c("commune", "lat", "long"), drop = TRUE]
pb <- unique (pb)
pb <- pb [c(1,3),]
pb
```

2 communes ne se trouvent pas avec le num INSEE
recherche des deux communes avec grep
spatialisation du fichier

```{r}
com [com$NOM_COM == "Bisseuil",]
com [grep ("seuil", com$NOM_COM),]
# attention séparateur long lat
pb$lat <- gsub(",", ".",pb$lat) 
pb$long <- gsub (",",".", pb$long)
pbst <- st_as_sf(pb, coords = c("long","lat"), crs = 4326)
pbst <- st_transform(pbst, crs = 2154)
class(pbst)
plot(pbst$geometry)
# il manque deux communes Mareuil et Bisseuil, on les spatialise à partir du fichier
# Elles sont dans AY-CHAMPAGNE
mapview(pbst)
voisin <- com [com$INSEE_REG == 44,]
zone <- st_within (pbst, voisin, sparse = T)
voisin
plot (voisin$geometry [222], col = NA)
plot(pbst$geom, add = TRUE)
labelLayer(pbst, txt = "COMMUNE", show.lines = TRUE)
labelLayer(voisin[222,], txt = "NOM_COM")
```

jointure pbst et les data
```{r}
str (pbst)
str(larves)
joinb <- merge(pbst, larves, by.x = "COMMUNE", by.y = "COMMUNE")
names(joinb) [1:2] <- c("NOM_COM", "INSEE_COM")
# prep des deux tables de jointures
colonnes <- c("NOM_COM", "INSEE_COM","data", "annee", "theme")
joinb <- joinb [, colonnes]
joint <- st_centroid(joint [,colonnes])
joinf <- rbind(joinb,joint)
joinf
```

data : passer en chiffre

```{r}
joinf$data <- gsub (" %", "",joinf$data)
joinf$data <- gsub(",", ".", joinf$data)
joinf$data <- as.numeric(joinf$data)
joinf
# 273 ok
st_write(joinf, "../dataS/larves.gpkg", "larves", delete_layer = T)
```




